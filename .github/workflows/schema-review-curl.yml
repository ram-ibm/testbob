name: Schema Review (Simple)

on:
  pull_request:
    paths:
      - '**.sql'
      - '**.ddl'

permissions:
  contents: read
  pull-requests: write

jobs:
  schema-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed SQL files
        id: changed-files
        run: |
          git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(sql|ddl)$' > changed_files.txt || true
          if [ -s changed_files.txt ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Review SQL files
        if: steps.changed-files.outputs.found == 'true'
        env:
          BOB_API_KEY: ${{ secrets.BOB_API_KEY }}
        run: |
          mkdir -p reviews
          while IFS= read -r sql_file; do
            echo "Reviewing: $sql_file"
            SQL_CONTENT=$(cat "$sql_file")
            PROMPT="Review this PostgreSQL schema file against ISV guidelines. Check for: tenant_id in primary key, TIMESTAMPTZ for timestamps, created and last_modified fields, no foreign keys, TEXT instead of VARCHAR. File: $sql_file. SQL: $SQL_CONTENT"
            PROMPT_JSON=$(echo "$PROMPT" | jq -Rs .)
            
            HTTP_CODE=$(curl -w "%{http_code}" -o "reviews/$(basename $sql_file)-response.json" \
              -X POST "https://us-south.ml.cloud.ibm.com/ml/v1/text/generation?version=2023-05-29" \
              -H "Authorization: Bearer $BOB_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"model_id\":\"ibm/granite-13b-chat-v2\",\"input\":$PROMPT_JSON,\"parameters\":{\"max_new_tokens\":2000,\"temperature\":0.3}}")
            
            echo "HTTP Status: $HTTP_CODE"
            cat "reviews/$(basename $sql_file)-response.json"
            
            if [ "$HTTP_CODE" -eq 200 ]; then
              jq -r '.results[0].generated_text' "reviews/$(basename $sql_file)-response.json" > "reviews/$(basename $sql_file)-review.md" 2>/dev/null || echo "API returned success but unexpected format" > "reviews/$(basename $sql_file)-review.md"
            else
              echo "API Error (HTTP $HTTP_CODE)" > "reviews/$(basename $sql_file)-review.md"
            fi
          done < changed_files.txt
      
      - name: Post review to PR
        if: steps.changed-files.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reviews = fs.readdirSync('reviews').filter(f => f.endsWith('-review.md')).map(f => fs.readFileSync(`reviews/${f}`, 'utf8')).join('\n\n---\n\n');
            await github.rest.issues.createComment({issue_number: context.issue.number, owner: context.repo.owner, repo: context.repo.repo, body: `## ðŸ¤– Bob AI Schema Review\n\n${reviews}`});

# Made with Bob
